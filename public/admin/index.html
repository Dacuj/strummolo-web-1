<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Content Manager</title>
</head>
<body>
  <script src="https://unpkg.com/netlify-cms@^2.10.192/dist/netlify-cms.js"></script>

  <script>
    const MY_WORKER_URL = "https://quiet-pond-f51b.davidecucciardi.workers.dev";
    
    // Configurazione Manuale (cosÃ¬ bypassiamo errori nel config.yml)
    const config = {
      backend: {
        name: 'github',
        repo: 'Dacuj/strummolo-web-1',
        branch: 'main',
        base_url: MY_WORKER_URL,
        auth_endpoint: 'auth'
      },
      media_folder: "public/img",
      public_folder: "/img",
      collections: [
        {
          name: "test",
          label: "Test",
          files: [
            { label: "Home", name: "home", file: "src/content/home.md", fields: [{label: "Title", name: "title", widget: "string"}] }
          ]
        }
      ]
    };

    // 1. Inizializza il CMS
    CMS.init({ config });

    // 2. LO "SNIFFER" DI MESSAGGI
    window.addEventListener("message", (event) => {
      // Se il messaggio arriva da noi stessi (il re-dispatch), ignoriamolo per non andare in loop
      if (event.origin === window.location.origin) return;

      // Filtra solo i messaggi dal tuo Worker
      if (event.origin === MY_WORKER_URL) {
        console.log("ðŸ”¥ MESSAGGIO INTERCETTATO DAL WORKER!");
        console.log("Raw Data:", event.data);

        // Verifica che sia il messaggio giusto
        if (typeof event.data === 'string' && event.data.startsWith("authorization:github:success:")) {
          
          // Estrai il JSON dalla stringa "authorization:github:success:{...}"
          const jsonString = event.data.split("authorization:github:success:")[1];
          
          try {
            const data = JSON.parse(jsonString);
            const token = data.token;
            console.log("ðŸ’Ž TOKEN ESTRATTO:", token.substring(0, 5) + "...");

            // 3. IL TRUCCO: Re-invia il messaggio come se venisse da QUI (Self)
            // Questo frega il CMS che accetta sempre i messaggi "interni"
            const fakeEvent = new MessageEvent("message", {
              data: event.data, // Usiamo gli stessi dati
              origin: window.location.origin, // MENTIAMO sull'origine
              source: window // Diciamo che la sorgente siamo noi stessi (sempre viva)
            });

            console.log("ðŸš€ FORZATURA LOGIN IN CORSO...");
            window.dispatchEvent(fakeEvent);
            
            // Backup: Se il CMS fallisce il parsing, stampiamo un link manuale
            document.body.insertAdjacentHTML('beforeend', `<div style="position:fixed; bottom:0; left:0; background:yellow; padding:20px; z-index:9999;">
              TOKEN RICEVUTO! Se non entra, controlla la console per errori API GitHub.
            </div>`);

          } catch (e) {
            console.error("Errore nel parsing del JSON del token", e);
          }
        }
      }
    });
  </script>
</body>
</html>