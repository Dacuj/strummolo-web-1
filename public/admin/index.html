<!-- <!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Strummolo Admin Panel</title>
  <link rel="icon" href="https://cur.cursors-4u.net/nature/nat-10/nat926.cur">
  <script src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>
</head>
<body>

  <script>
    window.addEventListener("message", (event) => {
      const data = event.data;
      if (typeof data === 'string' && data.startsWith("authorization:github:success:")) {
        console.log("‚ö° Token intercettato!");
        const parts = data.split(":");
        const token = parts[3]; 
        if (token) {
          const userObj = { backendName: "github", token: token };
          localStorage.setItem("netlify-cms-user", JSON.stringify(userObj));
          console.log("üíæ Salvato. Reload...");
          setTimeout(() => { window.location.reload(); }, 200);
        }
      }
    });
  </script>

  <script src="https://unpkg.com/netlify-cms@^2.10.192/dist/netlify-cms.js"></script>
  
  <script>
    // Carica il CSS
    CMS.registerPreviewStyle("/admin/preview.css");

    // Alias per React
    var createClass = React.createClass; 
    var h = React.createElement;

    // --- COMPONENTE PREVIEW ---
    var PostPreview = createClass({
      render: function() {
        var entry = this.props.entry;
        
        // Recupero Dati
        var title = entry.getIn(['data', 'title']);
        var desc = entry.getIn(['data', 'description']);
        var fileNum = entry.getIn(['data', 'fileNumber']) || 'UNK';
        var date = entry.getIn(['data', 'date']);
        
        // Formattazione Data (Simulazione formatDate di Astro: YYYY.MM.DD)
        var dateStr = 'YYYY.MM.DD';
        if (date) {
            try {
                // Se √® una stringa, convertila, se √® oggetto data, usa toISOString
                var d = new Date(date);
                dateStr = d.toISOString().split('T')[0].replace(/-/g, '.');
            } catch(e) {
                dateStr = date.toString();
            }
        }

        // --- RENDER DOM ---
        // Usiamo un <div> wrapper perch√© React < 16 vuole un solo elemento radice
        return h('div', {}, 
            
            // 1. NAV (<nav> fuori dall'article)
            h('nav', {},
                h('span', { className: 'nav-btn' }, '‚Üê Taccuino'),
                h('span', { className: 'nav-btn' }, 'Home')
            ),

            // 2. ARTICLE (<article class="article-container">)
            h('article', { className: 'article-container' },
                
                // HEADER (<header class="article-header">)
                h('header', { className: 'article-header' },
                    h('span', { className: 'meta-data' }, 'FILE: ' + fileNum + ' // DATE: ' + dateStr),
                    h('h1', {}, title),
                    h('p', { className: 'intro' }, desc) // Nota: Astro usa <p class="intro">
                ),

                // CONTENT (<div class="content">)
                h('div', { className: 'content' }, 
                    this.props.widgetFor('body'), // Il contenuto Markdown
                    
                    // END TRANSMISSION (<p style="...">)
                    // Uso una classe definita nel CSS per pulizia
                    h('p', { className: 'end-transmission' }, '*** END OF TRANSMISSION ***')
                ),

                // FOOTER (<footer class="article-footer">)
                h('footer', { className: 'article-footer' },
                    h('div', { className: 'prev-post' }), // Div vuoto come in Astro
                    
                    // Next Post (Finto per preview grafica)
                    h('a', { className: 'next-post', href: '#' },
                        h('span', { className: 'next-label' }, 'NEXT FILE ‚Üí'),
                        h('span', { className: 'next-title' }, '[PROSSIMO ARTICOLO]')
                    )
                )
            )
        );
      }
    });

    CMS.registerPreviewTemplate("taccuino", PostPreview);
  </script>

</body>
</html> -->

<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Strummolo Admin Panel | Decap CMS</title>
  <link rel="icon" href="https://cur.cursors-4u.net/nature/nat-10/nat926.cur">
  <script src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>
</head>
<body>

  <script>
    window.addEventListener("message", (event) => {
      const data = event.data;
      if (typeof data === 'string' && data.startsWith("authorization:github:success:")) {
        console.log("‚ö° Token intercettato!");
        const parts = data.split(":");
        const token = parts[3]; 
        if (token) {
          const userObj = { backendName: "github", token: token };
          localStorage.setItem("netlify-cms-user", JSON.stringify(userObj));
          console.log("üíæ Salvato. Reload...");
          setTimeout(() => { window.location.reload(); }, 200);
        }
      }
    });
  </script>

  <script src="https://unpkg.com/decap-cms@^3.0.0/dist/decap-cms.js"></script>
  
  <script>
    // 1. Registra lo stile CSS esterno
    CMS.registerPreviewStyle("/admin/preview.css");

    // 2. Setup React Moderno (No JSX)
    const h = window.React.createElement;

    // 3. Helper Formattazione Data (Simula Astro Logic)
    // Trasforma Date object o stringa ISO in YYYY.MM.DD
    const formatDate = (dateRaw) => {
        if (!dateRaw) return 'YYYY.MM.DD';
        try {
            const d = new Date(dateRaw);
            // Assicura che la data sia valida
            if (isNaN(d.getTime())) return String(dateRaw);
            return d.toISOString().split('T')[0].replace(/-/g, '.');
        } catch (e) {
            return String(dateRaw);
        }
    };

    // 4. Componente Preview (Functional Component / Arrow Function)
    const PostPreview = (props) => {
        // Estrazione dati immutable
        const entry = props.entry;
        const data = entry.get('data');
        
        // Campi
        const title = data.get('title') || 'Senza Titolo';
        const description = data.get('description') || '';
        const fileNumber = data.get('fileNumber') || 'UNK';
        const dateRaw = data.get('date');
        
        // Body (widget markdown)
        const bodyWidget = props.widgetFor('body');

        // Renderizza la struttura identica ad Astro
        // Nota: React richiede un unico genitore, usiamo un div wrapper neutro
        return h('div', {}, 
            
            // --- NAV ---
            h('nav', {},
                h('a', { href: '#', className: 'nav-btn' }, '‚Üê Taccuino'),
                h('a', { href: '#', className: 'nav-btn' }, 'Home')
            ),

            // --- ARTICLE ---
            h('article', { className: 'article-container' },
                
                // HEADER
                h('header', { className: 'article-header' },
                    h('span', { className: 'meta-data' }, 
                        `FILE: ${fileNumber} // DATE: ${formatDate(dateRaw)}`
                    ),
                    h('h1', {}, title),
                    h('p', { className: 'intro' }, description)
                ),

                // CONTENT
                h('div', { className: 'content' }, 
                    bodyWidget,

                    // "END OF TRANSMISSION"
                    // Replichiamo gli stili inline del componente Astro originale
                    h('p', { 
                        style: {
                            textAlign: 'center',
                            marginTop: '50px',
                            fontFamily: "'Press Start 2P'",
                            color: '#FC60B7'
                        }
                    }, '*** END OF TRANSMISSION ***')
                ),

                // FOOTER
                h('footer', { className: 'article-footer' },
                    h('div', { className: 'prev-post' }), // Spacer vuoto
                    
                    // Mock del "Next Post" (Visualizzazione statica per preview)
                    h('a', { href: '#', className: 'next-post' },
                        h('span', { className: 'next-label' }, 'NEXT FILE ‚Üí'),
                        h('span', { className: 'next-title' }, '[ANTEPRIMA PROSSIMO POST]')
                    )
                )
            )
        );
    };

    // 5. Registrazione Template
    CMS.registerPreviewTemplate("taccuino", PostPreview);
  </script>

</body>
</html>